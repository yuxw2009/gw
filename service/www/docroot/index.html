<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="/ringo/images/favicon.ico"/>
<!--script src="script/jquery-1.6.3.min.js" type="text/javascript"></script--> 
<!--<link rel="stylesheet" type="text/css" href="/ringo/style/style.css" />
<script src="script/p2pdemo.js" type="text/javascript"></script> 
<script src="script/restconnection.js" type="text/javascript"></script> 
<script src="script/restchannel.js" type="text/javascript"></script> 
<script src="script/jquery-1.6.3.min.js" type="text/javascript"></script> 
<script src="script/lworkVideoImport.js" type="text/javascript"></script> 
<script src="script/webrtc.js" type="text/javascript"></script> 
<script src="script/createwin.js" type="text/javascript"></script> 
<script src="script/tipsplugin.js" type="text/javascript"></script> 



<script src="script/lw_lang.js" type="text/javascript"></script> 
<script src="script/api.js" type="text/javascript"></script> 
<script src="script/voip.js" type="text/javascript"></script> 
<script src="script/restchannel.js" type="text/javascript"></script> 
<script src="script/restconnection.js" type="text/javascript"></script> 
<script src="script/p2pdemo.js" type="text/javascript"></script> 



-->

<title>demo</title>
</head>
<body>

<br />

<span>我的工号:</span><input id="my_uuid", type="text" name="" value="输入你的工号"  style="font-family: 微软雅黑; color: rgb(102, 102, 102);">
<br/>
<a id="get_free_room" class="voip_action" href="###" style="">获取房间</a>

<br />
<br />
<span class="peer_inputer">
    <input id="room_no", type="text" name="" value="输入房间号" class="peerNum" style="font-family: 微软雅黑; color: rgb(102, 102, 102);" dial-panel-mode="temp" phone="" sessionid="" peerstate="idle">
    <ul class="seatips" style="display: none;"> </ul>              
</span>

<span id="action_button">
	<a id="enter_room" class="voip_action" href="###" style="">进入房间</a>
	<a id="leave_room" class="voip_action" href="###" style="display:none">离开房间</a>
	<a class="kickout" href="###" style="display:none">挂断对方</a>
</span>
<br/>
<br/>
<span id="p2p_status"></span>
<br/>
<br/>
<span>
    <input id="uuids", type="text" name="" value="输入客服号,以逗号隔开"  style="font-family: 微软雅黑; color: rgb(102, 102, 102);">
    <ul class="seatips" style="display: none;"> </ul>              
</span> <a id="get_uuids_room_info" href="###" style=""> 获取客服房间信息</a>
<br/>
<span id = "opr_rooms_info">  </span>
<br>

<script src="script/jquery-1.6.3.min.js" type="text/javascript"></script> 
<script src="script/jquery.cookie.js" type="text/javascript"></script> 
<script src="script/lw2fzd.130905.js" type="text/javascript"></script> 

<script type="text/javascript">
	$('#voip_start').unbind('click').bind('click', function() {
		var phone=$('.peerNum').focus().val();
		voip_instance.lwStartVoip('12333', phone);
	});

$('#get_free_room').unbind('click').bind('click', function(){
	lwforfzdVoices.get_free_room({uuid:g_my_uuid()},function(d){
		$('#room_no').attr('value', d.room);
	}, function(){alert('get_free_room failed!')})
});

function g_my_uuid(){
    return $('#my_uuid').attr('value');	
}
var enter_room_clicked=function(room,curObj){
	var my_uuid = g_my_uuid();
	$.cookie('my_uuid', my_uuid);
	lwforfzdVoices.enter_room(
		{room:room,hide_id:false,uuid:my_uuid,
			cbs:{
				server_disc:function(d){
					$('#p2p_status').text('服务器已中断!');
					$('#leave_room').click();
				},
				incoming:function(d){
					$('#p2p_status').text('已接通'+d.from_uuid);
				},
				waiting:function(){
				 	$('#p2p_status').text('客服忙,排队中');
				},
				peerleave:function(){
					$('#p2p_status').text('对方已挂机');
				},
				release:function(){
					$('#p2p_status').text('房间已释放');
				},
				media_ok:function(){
					console.log("media_ok!!!");
				},
				media_fail:function(){
					console.log("media_failed!!!")
				},
				request_talking:function(data){
					$('#p2p_status').text('可以通话了').append('<a href="###" id="can_talk"> 进入</a>'+'<a href="###" class="kickout"> 拒绝</a>');
					$('#can_talk').unbind('click').bind('click', function(){
						lwforfzdVoices.waiting2talk();
						$(this).parent().children().remove();
						if(lwforfzdVoices.is_creator)$('#action_button').find('.kickout').show();
					})
					$('.kickout').unbind('click').bind('click', function(){
						lwforfzdVoices.kickout(data);
						$(this).hide();
					})
				}
			}
		},
		function(d){
			curObj.hide().next().show();
		}, 
		function(){alert('enter_room failed!')}
	)
}
var bind_enter_room = function(act_dom, room_dom) {
	act_dom.unbind('click').bind('click', function(){
			enter_room_clicked(room_dom.attr('value'), $(this));
		}
	);
};

bind_enter_room($('#enter_room'), $('#room_no'));

$('#leave_room').unbind('click').bind('click', function(){
	lwforfzdVoices.leave_room();
	$(this).hide().prev().show();
	$('#p2p_status').text("");
});

$('#get_uuids_room_info').unbind('click').bind('click',function(){
	var uuids = $('#uuids').attr('value');
	if(uuids=='') {alert('please input uuids');return;}
	var ids=uuids.split(',');
	function deal_room_infos(d){
		var infos=d.infos;
		var prt = $('#opr_rooms_info');
		prt.children().remove();
		for(var i=0;i<infos.length;i++){
			lwork_create_room_info(infos[i]).appendTo(prt);
		}
		prt.find('.enter_room').unbind('click').bind('click',function(){
			enter_room_clicked($(this).attr("value"),$(this));
		});
		prt.find('.leave_room').unbind('click').bind('click',function(){
			lwforfzdVoices.leave_room();
			$(this).hide().prev().show();
			$('#p2p_status').text("");
		});
		 
	};
	lwforfzdVoices.get_room_infos(ids, deal_room_infos, function(e){
		alert('fail to get_room_infos',e);
	})
})


function lwork_create_room_info(opts) {
	return $(['<span id="uuid_'+opts.uuid+'" style="width:150px;float:left"><span>工号:'+opts.uuid+'</span> <br/><span>'+'房间号:<span class="room_no"> '+opts.room+'</span></span>',
		'<span>'+'通话人数:'+opts.member_num+' </span>',
		'<span>'+'通话成员:'+opts.members_info.map(function(i){return i.uuid;}).join(",")+' </span>',
		'<span>'+'等待人数:'+opts.waiting_num+' </span>',
		'<span>'+'等待成员:'+opts.waitings_info.map(function(i){return i.uuid;}).join(",")+' </span>',
		'<span class="p2p_status"></span>',
		'<a class="enter_room" href="###" value="'+opts.room+'">进入房间</a> '+
		'<a class="leave_room"  href="###" style="display:none">离开房间</a></span>'].join('<br />'));
}

$('#my_uuid').attr('value', $.cookie('my_uuid'));
</script>
</body>
</html>