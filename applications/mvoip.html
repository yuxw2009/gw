<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<meta http-equiv="content-type" content="text/html; charset=utf-8;"/>
<html>
<head>
<style>
video {
  border:5px solid black;
  width:320px;
  height:240px;
}
button {
  font: 18px sans-serif;
  padding: 8px;
}
input {
  font: 48px;
  padding: 16px;
}
textarea {
  font-family: monospace;
  margin: 2px;
  width:480px;
  height:40px;
}
</style>
<script type="text/javascript" src="jquery.js"></script>

<script type="text/javascript">
var MVSession=null;
var MVPhone=null;
var MVTimer=null;

function trace(text) {
  if (text[text.length - 1] == '\n') {
    text = text.substring(0, text.length - 1);
  }
//  console.log((performance.webkitNow() / 1000).toFixed(3) + ": " + text);
  console.log((performance.now() / 1000).toFixed(3) + ": " + text);
}

function ajax_send_json(msg,callback) {
  $.post("mvoip.yaws?t=" + Math.random(), msg,callback,'json');
}

function pollack(msg) {
  $("#status").html(msg.ack);
  if(msg.ack == 'hook_on' || msg.ack == 'released'){
    trace("bye received.");
    if (MVTimer) {
      window.clearInterval(MVTimer);
      MVTimer = null;
  }
  }
}

function voip_pollstatus() {
  var message = {type:'get_voip_status', session:MVSession};
  ajax_send_json(message,pollack);
}

function voip_startack(msg) {
  $("#status").html(msg.type);
  $("#lport").html(msg.localport);
  $("#mysess").html(msg.session);
  MVSession = msg.session;
  if (!MVTimer)
  	MVTimer = setInterval(voip_pollstatus, 3000);
}

function voip_startcall() {
  var Session = document.getElementById('session').value;
  var PhNo = document.getElementById('phno').value;
  var M_IP = document.getElementById('m_ip').value;
  var M_Port = document.getElementById('m_port').value;
  var message = {type:'start_voip_call', 'session':Session,'ip':M_IP, 'port':M_Port, 'phone':PhNo};

  MVPhone = PhNo;
  ajax_send_json(message,voip_startack);
}

function voip_stopack(msg) {
  $("#status").html(msg.type);
  $("#lport").html(msg.duration);
  if (MVTimer) {
    window.clearInterval(MVTimer);
    MVTimer = null;
  }
}

function voip_stopcall() {
  var message = {type:'stop_voip_call', 'session':MVSession};

  ajax_send_json(message,voip_stopack);
}

</script>
</head>

<body>
<br>
<input id="session" type="text" value = "86"/>
<input id="phno" type="text" value = "008613801961496"/>
<input id="m_ip" type="text" value = "101.84.6.189"/>
<input id="m_port" type="text" value = "11113"/>
<br>
<div id="status"> </div>
<div id="lport"> </div>
<div id="mysess"> </div>
<br>
<button id="btn1" onclick="voip_startcall()">Call</button>
<button id="btn2" onclick="voip_stopcall()">Hang Up</button>
<br>

<script type="text/javascript">
btn1.disabled = false;
btn2.disabled = false;

</script>

</body>
</html>